# [Bug]: å­¤ç«‹ç‰©ä»¶çš„ Weak åƒè€ƒåœ¨å›æ”¶æ™‚å°è‡´è¨˜æ†¶é«”éŒ¯èª¤

**Status:** Fixed
**Tags:** Not Reproduced


## ğŸ“Š å¨è„…æ¨¡å‹è©•ä¼° (Threat Model Assessment)

| è©•ä¼°æŒ‡æ¨™ | ç­‰ç´š | èªªæ˜ |
| :--- | :--- | :--- |
| **Likelihood (ç™¼ç”Ÿæ©Ÿç‡)** | Medium | éœ€è¦è·¨åŸ·è¡Œç·’ä½¿ç”¨ Weak åƒè€ƒï¼Œä¸”ç‰©ä»¶æ‰€å±¬åŸ·è¡Œç·’çµ‚æ­¢ |
| **Severity (åš´é‡ç¨‹åº¦)** | Critical | å­˜å–å·²è§£é™¤æ˜ å°„çš„è¨˜æ†¶é«”å°è‡´ segfault |
| **Reproducibility (å¾©ç¾é›£åº¦)** | Medium | éœ€è¦ç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼ï¼ˆåŸ·è¡Œç·’çµ‚æ­¢ + Weak åƒè€ƒï¼‰ |

---

## ğŸ§© å—å½±éŸ¿çš„çµ„ä»¶èˆ‡ç’°å¢ƒ (Affected Component & Environment)
- **Component:** `sweep_orphan_pages`, `Weak::upgrade`, å­¤ç«‹é é¢å›æ”¶æ©Ÿåˆ¶
- **OS / Architecture:** Linux x86_64
- **Rust Version:** 1.75+
- **rudo-gc Version:** 0.8.0

---

## ğŸ“ å•é¡Œæè¿° (Description)

ç•¶ç‰©ä»¶çš„æ‰€å±¬åŸ·è¡Œç·’çµ‚æ­¢å¾Œï¼Œè©²åŸ·è¡Œç·’çš„ heap è®Šæˆã€Œå­¤ç«‹ã€ï¼ˆorphanedï¼‰ã€‚æ­¤æ™‚ï¼Œå³ä½¿ä»æœ‰ Weak åƒè€ƒæŒ‡å‘è©²ç‰©ä»¶çš„è¨˜æ†¶é«”ä½ç½®ï¼Œå­¤ç«‹é é¢å›æ”¶æ©Ÿåˆ¶ï¼ˆorphan sweepï¼‰ä»æœƒè§£é™¤æ˜ å°„è©²è¨˜æ†¶é«”ã€‚ç•¶ Weak åƒè€ƒå˜—è©¦å‘¼å« `upgrade()` æ™‚ï¼Œæœƒç™¼ç”Ÿè¨˜æ†¶é«”å­˜å–éŒ¯èª¤ï¼ˆsegfaultï¼‰ã€‚

### é æœŸè¡Œç‚º
- ç‰©ä»¶è¢« Drop å¾Œï¼ŒWeak åƒè€ƒçš„ `upgrade()` æ‡‰è©²è¿”å› `None`
- ä¸æ‡‰è©²ç™¼ç”Ÿ segfault æˆ–ä»»ä½•è¨˜æ†¶é«”éŒ¯èª¤

### å¯¦éš›è¡Œç‚º
1. åŸ·è¡Œç·’ A å‰µå»ºç‰©ä»¶ä¸¦å»ºç«‹ Weak åƒè€ƒ
2. åŸ·è¡Œç·’ A çµ‚æ­¢ï¼Œheap è®Šæˆå­¤ç«‹
3. GC åŸ·è¡Œå­¤ç«‹é é¢å›æ”¶ï¼ˆsweep_orphan_pagesï¼‰
4. è¨˜æ†¶é«”è¢«è§£é™¤æ˜ å°„
5. ä¸»åŸ·è¡Œç·’å‘¼å« `Weak::upgrade()`
6. **Segfault** - å­˜å–å·²è§£é™¤æ˜ å°„çš„è¨˜æ†¶é«”

---

## ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ (Root Cause Analysis)

åœ¨ `heap.rs` çš„ `sweep_orphan_pages` å‡½æ•¸ä¸­ï¼š

```rust
pub fn sweep_orphan_pages() {
    // ...
    manager.orphan_by_addr.retain(|_addr, orphan| unsafe {
        // æƒæä¸¦å›æ”¶å­¤ç«‹é é¢
        // æ²’æœ‰æª¢æŸ¥æ˜¯å¦æœ‰ Weak åƒè€ƒæŒ‡å‘é€™äº›é é¢
        let header = orphan.addr as *mut PageHeader;
        // ... å›æ”¶é‚è¼¯ ...
    });
}
```

å•é¡Œåœ¨æ–¼ï¼š
- å­¤ç«‹é é¢å›æ”¶æ™‚æ²’æœ‰æª¢æŸ¥æ˜¯å¦æœ‰ Weak åƒè€ƒæŒ‡å‘é€™äº›ç‰©ä»¶
- è¨˜æ†¶é«”è¢«ç›´æ¥è§£é™¤æ˜ å°„ï¼ˆunmapï¼‰ï¼Œè€Œæ²’æœ‰å…ˆç¢ºä¿ Weak åƒè€ƒå·²ç„¡æ•ˆ
- `Weak::upgrade()` å˜—è©¦å­˜å–å·²è¢«è§£é™¤æ˜ å°„çš„è¨˜æ†¶é«”

---

## ğŸ’£ é‡ç¾æ­¥é©Ÿ / æ¦‚å¿µé©—è­‰ (Steps to Reproduce / PoC)

```rust
use rudo_gc::{collect_full, Gc, Trace, Weak};
use std::thread;

struct LargeStruct {
    data: [u64; 10000],
}

unsafe impl Trace for LargeStruct {
    fn trace(&self, _visitor: &mut impl rudo_gc::Visitor) {}
}

fn main() {
    let weak_ref: Weak<LargeStruct>;

    let handle = thread::spawn(|| {
        Gc::downgrade(&Gc::new(LargeStruct {
            data: [0xCC; 10000],
        }))
    });

    weak_ref = handle.join().unwrap();

    collect_full();

    // é€™è£¡æ‡‰è©²è¿”å› Noneï¼Œä½†ä¸æ‡‰è©² segfault
    let result = std::panic::catch_unwind(|| weak_ref.upgrade());
    
    assert!(result.is_ok(), "å‡ç´šä¸æ‡‰è©² panic - è¨˜æ†¶é«”æ‡‰è©²å·²æ˜ å°„");
    let upgraded = result.unwrap();
    assert!(upgraded.is_none(), "æ‡‰è©²è¿”å› Noneï¼ˆç‰©ä»¶å·²æ­»äº¡ï¼‰");
    
    drop(weak_ref);
    collect_full();
}
```

åŸ·è¡Œæ¸¬è©¦ï¼š
```bash
cargo test --test bug2_orphan_sweep_weak_ref -- --test-threads=1
```

---

## ğŸ› ï¸ å»ºè­°ä¿®å¾©æ–¹æ¡ˆ (Suggested Fix / Remediation)

### æ–¹æ¡ˆ 1ï¼šè¿½è¹¤ Weak åƒè€ƒçš„ç›®æ¨™é é¢ï¼ˆæ¨è–¦ï¼‰
åœ¨ `GcBoxWeakRef` ä¸­è¿½è¹¤ç›®æ¨™ç‰©ä»¶æ‰€åœ¨çš„é é¢åœ°å€ã€‚åœ¨å­¤ç«‹é é¢å›æ”¶å‰ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ Weak åƒè€ƒæŒ‡å‘å³å°‡è¢«å›æ”¶çš„é é¢ã€‚å¦‚æœæœ‰ï¼Œå‰‡å»¶é²å›æ”¶ç›´åˆ°æ‰€æœ‰ Weak åƒè€ƒè¢«æ¸…é™¤ã€‚

### æ–¹æ¡ˆ 2ï¼šå»¶é²è¨˜æ†¶é«”è§£é™¤æ˜ å°„
ä¸è¦åœ¨å›æ”¶æ™‚ç«‹å³è§£é™¤æ˜ å°„è¨˜æ†¶é«”ï¼Œè€Œæ˜¯å°‡å…¶æ¨™è¨˜ç‚ºã€Œå³å°‡å›æ”¶ã€ä¸¦å»¶é²å¯¦éš›çš„è§£é™¤æ˜ å°„æ“ä½œã€‚é€™çµ¦äºˆ Weak åƒè€ƒå‘¼å« `upgrade()` çš„æ©Ÿæœƒä¾†æª¢æŸ¥ç‰©ä»¶ç‹€æ…‹ã€‚

### æ–¹æ¡ˆ 3ï¼šåœ¨ `upgrade()` ä¸­æ·»åŠ å®‰å…¨æª¢æŸ¥
åœ¨ `Weak::upgrade()` ä¸­æ·»åŠ è¨˜æ†¶é«”æœ‰æ•ˆæ€§æª¢æŸ¥ã€‚å¦‚æœè¨˜æ†¶é«”å·²è¢«è§£é™¤æ˜ å°„ï¼Œè¿”å› `None` è€Œä¸æ˜¯å˜—è©¦å­˜å–è¨˜æ†¶é«”ã€‚

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ Mremap å»¶é²å›æ”¶
ä½¿ç”¨ `mremap` å°‡å›æ”¶çš„è¨˜æ†¶é«”æ˜ å°„åˆ°ä¸€å€‹ guard pageï¼Œè€Œä¸æ˜¯å®Œå…¨è§£é™¤æ˜ å°„ã€‚é€™æ¨£å­˜å–æ™‚æœƒè§¸ç™¼ segmentation faultï¼ˆå¯æ•æ‰ï¼‰ï¼Œè€Œä¸æ˜¯æœªå®šç¾©è¡Œç‚ºã€‚

---

## ğŸ—£ï¸ å…§éƒ¨è¨è«–ç´€éŒ„ (Internal Discussion Record)

**R. Kent Dybvig (GC æ¶æ§‹è§€é»):**
æ­¤å•é¡Œæ¶‰åŠ Weak åƒè€ƒèˆ‡åŸ·è¡Œç·’ç”Ÿå‘½é€±æœŸçš„äº¤äº’ã€‚åœ¨å‚³çµ± GC ä¸­ï¼Œæ‰€æœ‰ç‰©ä»¶éƒ½åœ¨å…±äº«çš„ heap ä¸­ç®¡ç†ï¼ŒWeak åƒè€ƒçš„è™•ç†ç›¸å°ç°¡å–®ã€‚ä½† rudo-gc çš„åŸ·è¡Œç·’æœ¬åœ°åˆ†é…æ¨¡å‹å¢åŠ äº†è¤‡é›œæ€§ï¼Œéœ€è¦ç¢ºä¿åŸ·è¡Œç·’çµ‚æ­¢æ™‚çš„æ‰€æœ‰æ¬Šè½‰æ›æ˜¯å®‰å…¨çš„ã€‚

**Rustacean (Soundness è§€é»):**
é€™æ˜¯æœªå®šç¾©è¡Œç‚ºã€‚å­˜å–å·²è§£é™¤æ˜ å°„çš„è¨˜æ†¶é«”æ˜¯ UBï¼Œç„¡è«–æ˜¯å¦é€é Weak åƒè€ƒã€‚å¿…é ˆç¢ºä¿ Weak::upgrade() æ°¸é ä¸æœƒå°è‡´è¨˜æ†¶é«”éŒ¯èª¤ã€‚

**Geohot (Exploit è§€é»):**
æ”»æ“Šè€…å¯ä»¥é€šéï¼š
1. æ§‹é€  Weak åƒè€ƒèˆ‡åŸ·è¡Œç·’çµ‚æ­¢çš„ race condition
2. æ´©éœ²è¨˜æ†¶é«”ä½ˆå±€è³‡è¨Šï¼ˆé€éè§€å¯Ÿä½•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼‰
3. å¯èƒ½å¯¦ç¾ä»»æ„è¨˜æ†¶é«”è®€å–ï¼ˆå¦‚æœéŒ¯èª¤è™•ç†ä¸ç•¶ï¼‰

