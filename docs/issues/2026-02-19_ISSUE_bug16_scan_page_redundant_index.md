# [Bug]: scan_page_for_marked_refs å†—é¤˜çš„ç‰©ä»¶ç´¢å¼•è¨ˆç®—

**Status:** Fixed
**Tags:** Verified


## ğŸ“Š å¨è„…æ¨¡å‹è©•ä¼° (Threat Model Assessment)

| è©•ä¼°æŒ‡æ¨™ | ç­‰ç´š | èªªæ˜ |
| :--- | :--- | :--- |
| **Likelihood (ç™¼ç”Ÿæ©Ÿç‡)** | Low | ç¨‹å¼ç¢¼è·¯å¾‘å¿…å®šåŸ·è¡Œï¼Œä½†çµæœæ­£ç¢º |
| **Severity (åš´é‡ç¨‹åº¦)** | Low | æ•ˆèƒ½å•é¡Œï¼Œéæ­£ç¢ºæ€§å•é¡Œ |
| **Reproducibility (å¾©ç¾é›£åº¦)** | Very Low | ç¨‹å¼ç¢¼å¿…å®šè§¸ç™¼ï¼Œä½†å½±éŸ¿è¼•å¾® |

---

## ğŸ§© å—å½±éŸ¿çš„çµ„ä»¶èˆ‡ç’°å¢ƒ (Affected Component & Environment)
- **Component:** `scan_page_for_marked_refs` (gc/incremental.rs)
- **OS / Architecture:** All
- **Rust Version:** 1.75+
- **rudo-gc Version:** Current main branch

---

## ğŸ“ å•é¡Œæè¿° (Description)

### é æœŸè¡Œç‚º (Expected Behavior)
å‡½æ•¸æ‡‰è©²æœ‰æ•ˆç‡åœ°æƒæé é¢ä¸­æ‰€æœ‰å·²é…ç½®ç‰©ä»¶ï¼Œä¸¦å°‡æœªæ¨™è¨˜çš„å¼•ç”¨åŠ å…¥ worklistã€‚

### å¯¦éš›è¡Œç‚º (Actual Behavior)
ç¨‹å¼ç¢¼ä¸­å­˜åœ¨å†—é¤˜ä¸”ä»¤äººå›°æƒ‘çš„ç´¢å¼•è¨ˆç®—ï¼š

```rust
for i in 0..obj_count {
    if (*header).is_allocated(i) && !(*header).is_marked(i) {
        let obj_ptr = header.cast::<u8>().add(header_size + i * block_size);
        refs_found += 1;
        if let Some(idx) = ptr_to_object_index(obj_ptr.cast()) {
            // é€™è£¡ idx == iï¼Œå†—é¤˜è¨ˆç®—ï¼
            if !(*header).is_marked(idx) {  // é€™è¡Œæ°¸é ä¸æœƒåŸ·è¡Œï¼Œå› ç‚ºå‰é¢å·²ç¶“æª¢æŸ¥é !is_marked(i)
                (*header).set_mark(idx);
                // ...
            }
        }
    }
}
```

è¿´åœˆä¸­çš„è®Šæ•¸ `i` æœ¬èº«å°±æ˜¯ç‰©ä»¶ç´¢å¼•ã€‚`ptr_to_object_index(obj_ptr)` é‡æ–°è¨ˆç®—äº†ç›¸åŒçš„ç´¢å¼•ã€‚é€™ä¸åƒ…æ˜¯å†—é¤˜è¨ˆç®—ï¼Œç¬¬äºŒå€‹ `is_marked(idx)` æª¢æŸ¥ä¹Ÿæ°¸é ä¸æœƒåŸ·è¡Œï¼ˆå› ç‚ºå¤–å±¤å·²ç¶“æª¢æŸ¥é `!is_marked(i)`ï¼‰ã€‚

---

## ğŸ”¬ æ ¹æœ¬åŸå› åˆ†æ (Root Cause Analysis)

1. **å†—é¤˜è¨ˆç®—**ï¼š`i` å·²ç¶“æ˜¯ç‰©ä»¶ç´¢å¼•ï¼Œå‘¼å« `ptr_to_object_index(obj_ptr)` æœƒé‡è¤‡è¨ˆç®—
2. **æ­»ç¨‹å¼ç¢¼**ï¼šç¬¬äºŒå€‹ `is_marked(idx)` æª¢æŸ¥æ¢ä»¶æ°¸é ç‚º falseï¼ˆå› ç‚ºå¤–å±¤å·²ç¢ºä¿ `!is_marked(i)` ç‚º trueï¼Œè€Œ `idx == i`ï¼‰
3. **ç¶­è­·æ€§å•é¡Œ**ï¼šå¦‚æœæœªä¾†æŒ‡æ¨™è¨ˆç®—é‚è¼¯æ”¹è®Šï¼Œé€™æ®µç¨‹å¼ç¢¼å¯èƒ½æˆç‚º bug ä¾†æº

---

## ğŸ’£ é‡ç¾æ­¥é©Ÿ / æ¦‚å¿µé©—è­‰ (Steps to Reproduce / PoC)

é€™ä¸æ˜¯ä¸€å€‹æ­£ç¢ºæ€§ bugï¼Œè€Œæ˜¯ç¨‹å¼ç¢¼å“è³ªå•é¡Œã€‚å¯ä»¥é€éç¨‹å¼ç¢¼å¯©æŸ¥ç™¼ç¾ï¼š

```rust
// åœ¨ gc/incremental.rs ä¸­æ‰¾åˆ° scan_page_for_marked_refs å‡½æ•¸
// è§€å¯Ÿå†—é¤˜çš„ idx è¨ˆç®—å’Œæ°¸é ä¸æœƒåŸ·è¡Œçš„ is_marked(idx) æª¢æŸ¥
```

---

## ğŸ› ï¸ å»ºè­°ä¿®å¾©æ–¹æ¡ˆ (Suggested Fix / Remediation)

1. **ç§»é™¤å†—é¤˜è¨ˆç®—**ï¼šç›´æ¥ä½¿ç”¨ `i` ä½œç‚ºç´¢å¼•ï¼Œä¸éœ€è¦ `ptr_to_object_index` é‡æ–°è¨ˆç®—

2. **ç°¡åŒ–é‚è¼¯**ï¼šå› ç‚º `i == idx`ï¼Œå¯ä»¥ç§»é™¤ç¬¬äºŒå€‹ `is_marked` æª¢æŸ¥

ä¿®æ­£å¾Œçš„ç¨‹å¼ç¢¼ï¼š
```rust
for i in 0..obj_count {
    if (*header).is_allocated(i) && !(*header).is_marked(i) {
        let obj_ptr = header.cast::<u8>().add(header_size + i * block_size);
        refs_found += 1;
        (*header).set_mark(i);  // ç›´æ¥ä½¿ç”¨ i
        // ...
    }
}
```

---

## ğŸ—£ï¸ å…§éƒ¨è¨è«–ç´€éŒ„ (Internal Discussion Record)

**R. Kent Dybvig (GC æ¶æ§‹è§€é»):**
é€™æ˜¯ä¸€å€‹æ•ˆèƒ½å•é¡Œè€Œéæ­£ç¢ºæ€§å•é¡Œã€‚åœ¨ GC çš„ç†±è·¯å¾‘ä¸Šï¼Œä»»ä½•å¤šé¤˜çš„è¨ˆç®—éƒ½æœƒç´¯ç©ã€‚é›–ç„¶å½±éŸ¿å¯èƒ½ä¸å¤§ï¼Œä½†åœ¨æ¨™è¨˜éšæ®µï¼Œé€™æ®µç¨‹å¼ç¢¼æœƒè¢«é »ç¹å‘¼å«ã€‚å»ºè­°å„ªåŒ–ä¸¦ç§»é™¤å†—é¤˜è¨ˆç®—ã€‚

**Rustacean (Soundness è§€é»):**
é€™æ®µç¨‹å¼ç¢¼æ²’æœ‰è¨˜æ†¶é«”å®‰å…¨å•é¡Œï¼Œä½†æœ‰æ­»ç¨‹å¼ç¢¼ (dead code) å’Œä¸å¿…è¦çš„ unsafe ä½¿ç”¨ã€‚`ptr_to_object_index` çš„å‘¼å«åœ¨é€™ç¨®æƒ…æ³ä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚å»ºè­°ä½¿ç”¨ clippy ä¾†æª¢æ¸¬æ­¤é¡å•é¡Œã€‚

**Geohot (Exploit è§€é»):**
é€™ä¸æ˜¯å®‰å…¨æ¼æ´ï¼Œä½†è¤‡é›œçš„æŒ‡æ¨™é‹ç®—å¯èƒ½éš±è—å…¶ä»–å•é¡Œã€‚æ”»æ“Šè€…å¯èƒ½æœƒåˆ©ç”¨è¤‡é›œçš„æŒ‡æ¨™é‹ç®—é‚è¼¯å°‹æ‰¾æ¼æ´ã€‚å»ºè­°ç°¡åŒ–ç¨‹å¼ç¢¼ä»¥æé«˜å¯å¯©è¨ˆæ€§ã€‚
