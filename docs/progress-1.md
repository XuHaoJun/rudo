# 專案進度報告：rudo-gc 實作現狀分析

**致 John McCarthy 博士：**

我們已針對目前 `crates/rudo-gc/src` 的實作完成分析。依照您的設計藍圖，目前系統正處於「方案 A (保守式 GC)」的基礎建設階段。以下是具體的評估報告：

## 1. 執行緒劫持與 Safepoint 策略
目前系統尚處於單執行緒環境，但已具備「溫和派 (Software Polling)」的初步特徵：
- **觸發機制**：利用 `Drop` trait 作為隱式 Safepoint。每次 `Gc<T>` 釋放時都會觸發 `maybe_collect` 檢查。
- **劫持現狀**：尚未實作 `SharedGc` 或 `TLAB`。目前的 `GlobalHeap` 是執行緒區域 (Thread-local) 的。
- **評估**：架構已為「軟體輪詢」留出空間，但若要支援多執行緒，必須將 `N_DROPS` 與 `COLLECT_CONDITION` 升級為全域協調機制。

## 2. 根源掃描 (Root Scanning)
我們完全採納了您提議的「保守式掃描」以避開修改 Rust 編譯器的難題：
- **堆疊與暫存器**：實作了 `spill_registers_and_scan`，手動將 x86_64 暫存器推入堆疊，並執行全堆疊掃描。
- **指針識別**：透過一系列啟發式檢查（對齊、頁面 Magic Number、物件索引有效性）來驗證潛在指針。
- **評估**：目前的掃描邏輯是「盲目且保守的」，這正是我們需要防禦「偽陽性 (False Positive)」的關鍵點。

## 3. 記憶體佈局：BiBOP 實作
核心記憶體管理已採用 **BiBOP (Big Bag of Pages)** 佈局：
- **分級管理**：針對不同 Size Classes (16B - 2KB) 劃分 Page，並支援大物件空間 (Large Object Space)。
- **位圖追蹤**：Page Header 包含 `mark_bitmap` 與 `allocated_bitmap`，實現了 O(1) 的元數據查找。

## 4. 數學防線：地址空間著色與黑名單
這是目前實作中最薄弱的環節，尚未建立數學防線：
- **防禦現狀**：目前依賴標準 `alloc` 分配頁面，尚未採用 `mmap` Hint 進行 **地址空間著色 (Coloring)**。
- **洩漏風險**：由於缺乏 **黑名單 (Blacklisting)** 機制，在長時間運行的極端情況下，長壽命的堆疊整數仍可能導致記憶體洩漏。

---

## 總結與下一步行動

您的「游擊戰術」在 `rudo-gc` 中已初具規模。為了讓這個專案從「實驗室雛形」升級為「工業級穩定」，我們建議下一階段的開發重點應放在：
1.  **實作地址空間著色**：透過系統呼叫強迫 Heap 落在特定的地址範圍。
2.  **建立預分配黑名單**：在分配新 Page 前掃描堆疊以避開「地雷區」。
3.  **TLAB 與全域協調**：開始從 `thread_local!` 轉向支援多執行緒的並行分配架構。

**您的學生與追隨者，**
*rudo-gc 開發團隊*
